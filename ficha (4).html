<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha da Aeronave</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card-collapse { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .card-collapse.expanded { max-height: 1000px; } /* Um valor grande o suficiente para o conte√∫do */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        .floating-action { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
        .rotate-180 { transform: rotate(180deg); }
        #aircraft_image {
            width: 100%;
            height: 192px; /* h-48 */
            object-fit: contain; /* Evita que a imagem seja cortada */
            background-color: #f3f4f6; /* Cor de fundo para caso a imagem n√£o preencha tudo */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-400 to-blue-600 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md" id="ficha_container">
        <!-- Header Card -->
        <div class="bg-white rounded-2xl shadow-xl mb-4 overflow-hidden">
            <div class="bg-gradient-to-r from-slate-700 to-slate-900 text-white p-4 text-center">
                <h1 id="aircraft_name" class="text-xl font-bold mb-1">Nome da Aeronave</h1>
                <p id="aircraft_subtitle" class="text-sm opacity-90">Tipo - Doutrina</p>
            </div>
            
            <!-- Aircraft Image -->
            <div class="p-4">
                <div class="relative bg-gray-100 rounded-xl overflow-hidden mb-3">
                    <img id="aircraft_image" src="https://placehold.co/400x250/5F9EA0/ffffff?text=AERONAVE" 
                         alt="Aeronave" class="w-full h-48">
                    <button class="absolute top-2 right-2 bg-black/50 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-black/70 transition-colors"
                            id="open-image-selector-btn">
                        <i class="fas fa-camera text-sm"></i>
                    </button>
                </div>
                
                <!-- Quick Stats -->
                <div class="stats-grid text-sm">
                    <div class="bg-blue-50 p-2 rounded-lg text-center">
                        <div class="text-blue-600 font-semibold" id="unit_cost">$0</div>
                        <div class="text-xs text-gray-600">Custo</div>
                    </div>
                    <div class="bg-green-50 p-2 rounded-lg text-center">
                        <div class="text-green-600 font-semibold" id="max_speed">0 km/h</div>
                        <div class="text-xs text-gray-600">Vel. M√°x</div>
                    </div>
                    <div class="bg-purple-50 p-2 rounded-lg text-center">
                        <div class="text-purple-600 font-semibold" id="total_power">0 HP</div>
                        <div class="text-xs text-gray-600">Pot√™ncia</div>
                    </div>
                    <div class="bg-orange-50 p-2 rounded-lg text-center">
                        <div class="text-orange-600 font-semibold" id="reliability">0%</div>
                        <div class="text-xs text-gray-600">Confiabilidade</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Chart Card -->
        <div class="bg-white rounded-2xl shadow-lg mb-4 overflow-hidden">
            <button class="w-full p-4 text-left flex items-center justify-between bg-gradient-to-r from-blue-50 to-blue-100 toggle-card-btn" data-card="performance_card">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-blue-600 mr-3"></i>
                    <span class="font-semibold text-gray-800">Gr√°fico de Performance</span>
                </div>
                <i class="fas fa-chevron-down transform transition-transform" id="performance_card_icon"></i>
            </button>
            <div id="performance_card" class="card-collapse expanded"> <!-- Expanded by default -->
                <div class="p-4">
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Card -->
        <div class="bg-white rounded-2xl shadow-lg mb-4 overflow-hidden">
            <button class="w-full p-4 text-left flex items-center justify-between bg-gradient-to-r from-green-50 to-green-100 toggle-card-btn" data-card="stats_card">
                <div class="flex items-center">
                    <i class="fas fa-tachometer-alt text-green-600 mr-3"></i>
                    <span class="font-semibold text-gray-800">Estat√≠sticas Completas</span>
                </div>
                <i class="fas fa-chevron-down transform transition-transform" id="stats_card_icon"></i>
            </button>
            <div id="stats_card" class="card-collapse expanded"> <!-- Expanded by default -->
                <div class="p-4 space-y-3">
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="flex justify-between p-2 bg-gray-50 rounded">
                            <span class="text-gray-600">Peso:</span>
                            <span id="total_weight" class="font-medium">0 kg</span>
                        </div>
                        <div class="flex justify-between p-2 bg-gray-50 rounded">
                            <span class="text-gray-600">Subida:</span>
                            <span id="rate_of_climb" class="font-medium">0 m/s</span>
                        </div>
                        <div class="flex justify-between p-2 bg-gray-50 rounded">
                            <span class="text-gray-600">Teto:</span>
                            <span id="service_ceiling" class="font-medium">0 m</span>
                        </div>
                        <div class="flex justify-between p-2 bg-gray-50 rounded">
                            <span class="text-gray-600">Alcance:</span>
                            <span id="max_range" class="font-medium">0 km</span>
                        </div>
                        <div class="flex justify-between p-2 bg-gray-50 rounded">
                            <span class="text-gray-600">Manobra:</span>
                            <span id="turn_time" class="font-medium">0s</span>
                        </div>
                        <div class="flex justify-between p-2 bg-gray-50 rounded">
                            <span class="text-gray-600">Tripula√ß√£o:</span>
                            <span id="num_crewmen" class="font-medium">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Armament Card -->
        <div class="bg-white rounded-2xl shadow-lg mb-4 overflow-hidden">
            <button class="w-full p-4 text-left flex items-center justify-between bg-gradient-to-r from-red-50 to-red-100 toggle-card-btn" data-card="armament_card">
                <div class="flex items-center">
                    <i class="fas fa-crosshairs text-red-600 mr-3"></i>
                    <span class="font-semibold text-gray-800">Armamentos</span>
                </div>
                <i class="fas fa-chevron-down transform transition-transform" id="armament_card_icon"></i>
            </button>
            <div id="armament_card" class="card-collapse expanded"> <!-- Expanded by default -->
                <div class="p-4 space-y-3">
                    <div>
                        <span class="text-sm font-medium text-gray-600">Ofensivo:</span>
                        <p id="offensive_armament" class="text-sm mt-1">Nenhum</p>
                    </div>
                    <div>
                        <span class="text-sm font-medium text-gray-600">Defensivo:</span>
                        <p id="defensive_armament" class="text-sm mt-1">Nenhum</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Design Details Card -->
        <div class="bg-white rounded-2xl shadow-lg mb-4 overflow-hidden">
            <button class="w-full p-4 text-left flex items-center justify-between bg-gradient-to-r from-purple-50 to-purple-100 toggle-card-btn" data-card="design_card">
                <div class="flex items-center">
                    <i class="fas fa-cog text-purple-600 mr-3"></i>
                    <span class="font-semibold text-gray-800">Detalhes do Projeto</span>
                </div>
                <i class="fas fa-chevron-down transform transition-transform" id="design_card_icon"></i>
            </button>
            <div id="design_card" class="card-collapse expanded"> <!-- Expanded by default -->
                <div class="p-4 space-y-3 text-sm">
                    <div class="border-b pb-2">
                        <span class="font-medium text-gray-700">Tipo:</span>
                        <span id="aircraft_type" class="ml-2">-</span>
                    </div>
                    <div class="border-b pb-2">
                        <span class="font-medium text-gray-700">Estrutura:</span>
                        <span id="structure_type" class="ml-2">-</span>
                    </div>
                    <div class="border-b pb-2">
                        <span class="font-medium text-gray-700">H√©lice:</span>
                        <span id="propeller_type" class="ml-2">-</span>
                    </div>
                    <div class="border-b pb-2">
                        <span class="font-medium text-gray-700">Refrigera√ß√£o:</span>
                        <span id="cooling_system" class="ml-2">-</span>
                    </div>
                    <div class="border-b pb-2">
                        <span class="font-medium text-gray-700">Asa:</span>
                        <span id="wing_type" class="ml-2">-</span>
                    </div>
                    <div>
                        <span class="font-medium text-gray-700">Trem de Pouso:</span>
                        <span id="landing_gear_type" class="ml-2">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Cards Grid -->
        <div class="grid grid-cols-2 gap-3 mb-20">
            <!-- Wings & Engine -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <button class="w-full p-3 text-left bg-gradient-to-r from-amber-50 to-amber-100 toggle-card-btn" data-card="wings_engine_card">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-feather text-amber-600 mr-2 text-sm"></i>
                            <span class="font-medium text-sm">Asas & Motor</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transform transition-transform" id="wings_engine_card_icon"></i>
                    </div>
                </button>
                <div id="wings_engine_card" class="card-collapse expanded"> <!-- Expanded by default -->
                    <div class="p-3 text-xs space-y-2">
                        <div>
                            <span class="font-medium text-gray-600">Asas:</span>
                            <div id="wing_features" class="mt-1 text-gray-700"></div>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Motor:</span>
                            <div id="engine_enhancements" class="mt-1 text-gray-700"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Protection & Cockpit -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <button class="w-full p-3 text-left bg-gradient-to-r from-emerald-50 to-emerald-100 toggle-card-btn" data-card="protection_cockpit_card">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-shield text-emerald-600 mr-2 text-sm"></i>
                            <span class="font-medium text-sm">Prote√ß√£o & Cockpit</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transform transition-transform" id="protection_cockpit_card_icon"></i>
                    </div
                </button>
                <div id="protection_cockpit_card" class="card-collapse expanded"> <!-- Expanded by default -->
                    <div class="p-3 text-xs space-y-2">
                        <div>
                            <span class="font-medium text-gray-600">Prote√ß√£o:</span>
                            <div id="protection" class="mt-1 text-gray-700"></div>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">Cockpit:</span>
                            <div id="cockpit_comfort" class="mt-1 text-gray-700"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avionics & Equipment -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden col-span-2">
                <button class="w-full p-3 text-left bg-gradient-to-r from-cyan-50 to-cyan-100 toggle-card-btn" data-card="avionics_equipment_card">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-satellite-dish text-cyan-600 mr-2 text-sm"></i>
                            <span class="font-medium text-sm">Avi√¥nicos & Equipamentos</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs transform transition-transform" id="avionics_equipment_card_icon"></i>
                    </div>
                </button>
                <div id="avionics_equipment_card" class="card-collapse expanded"> <!-- Expanded by default -->
                    <div class="p-3 text-xs space-y-2">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <span class="font-medium text-gray-600">Avi√¥nicos:</span>
                                <div id="advanced_avionics" class="mt-1 text-gray-700"></div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">Equipamentos:</span>
                                <div id="equipment" class="mt-1 text-gray-700"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="floating-action">
        <button id="save-as-png-btn"
                class="bg-green-500 text-white w-14 h-14 rounded-full shadow-2xl hover:bg-green-600 transition-transform hover:scale-110 flex items-center justify-center">
            <i class="fas fa-download text-lg"></i>
        </button>
    </div>

    <!-- Image Selector Modal -->
    <div id="image_modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4">Alterar Imagem</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Upload de Imagem:</label>
                    <input type="file" id="image_upload" accept="image/*" 
                           class="w-full p-2 border rounded-lg text-sm">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Ou escolha uma aeronave:</label>
                    <select id="aircraft_select" class="w-full p-2 border rounded-lg text-sm">
                        <option value="">Selecione...</option>
                    </select>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="apply-image-btn"
                        class="flex-1 bg-blue-500 text-white py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors">
                    Aplicar
                </button>
                <button id="close-image-modal-btn"
                        class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { gameData, realWorldAircraft } from './assets/js/data.js';
        import { getAirPropertiesAtAltitude, calculateEnginePowerAtAltitude, calculatePerformanceAtAltitude, calculateRateOfClimb } from './assets/js/calculations.js';
        
        let aircraftData = {};
        let performanceChart = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
        });

        function loadData() {
            const aircraftDataString = localStorage.getItem('aircraftSheetData');
            const realWorldAircraftString = localStorage.getItem('realWorldAircraftData');

            if (realWorldAircraftString) {
                try {
                    const parsedRealWorldAircraft = JSON.parse(realWorldAircraftString);
                    populateAircraftSelect(parsedRealWorldAircraft);
                } catch (e) {
                    console.error("Erro ao parsear dados de aeronaves reais do localStorage", e);
                }
            } else {
                populateAircraftSelect(realWorldAircraft);
            }

            if (aircraftDataString) {
                aircraftData = JSON.parse(aircraftDataString);
                populateSheet();
                createPerformanceChart();
            } else {
                document.getElementById('aircraft_name').textContent = 'Dados n√£o encontrados';
                document.getElementById('aircraft_subtitle').textContent = 'Volte e gere a ficha novamente.';
            }
        }

        function setupEventListeners() {
            document.getElementById('save-as-png-btn').addEventListener('click', saveAsPNG);
            document.getElementById('apply-image-btn').addEventListener('click', applyImageSelection);
            document.getElementById('close-image-modal-btn').addEventListener('click', closeImageSelector);
            document.querySelectorAll('.toggle-card-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const cardId = button.getAttribute('data-card');
                    toggleCard(cardId);
                });
            });
            document.getElementById('open-image-selector-btn').addEventListener('click', openImageSelector);
        }

        function populateSheet() {
            document.getElementById('aircraft_name').textContent = aircraftData.inputs?.aircraftName || 'Nome da Aeronave';
            document.getElementById('aircraft_subtitle').textContent = `${aircraftData.typeData?.name || 'Tipo'} - ${aircraftData.inputs?.selectedAirDoctrine ? gameData.doctrines[aircraftData.inputs.selectedAirDoctrine]?.name : 'Doutrina'}`;
            document.getElementById('unit_cost').textContent = (aircraftData.adjustedUnitCost?.toLocaleString('pt-BR') || '$0');
            document.getElementById('max_speed').textContent = `${Math.round(aircraftData.finalSpeedKmhAlt)?.toLocaleString('pt-BR') || '0'} km/h`;
            document.getElementById('total_power').textContent = `${Math.round(aircraftData.totalEnginePower)?.toLocaleString('pt-BR') || '0'} HP`;
            document.getElementById('reliability').textContent = `${aircraftData.finalReliability?.toFixed(1) || '0'}%`;
            document.getElementById('total_weight').textContent = `${Math.round(aircraftData.combatWeight)?.toLocaleString('pt-BR') || '0'} kg`;
            document.getElementById('rate_of_climb').textContent = `${aircraftData.rate_of_climb_ms?.toFixed(1) || '0'} m/s`;
            document.getElementById('service_ceiling').textContent = `${Math.round(aircraftData.finalServiceCeiling)?.toLocaleString('pt-BR') || '0'} m`;
            document.getElementById('max_range').textContent = `${Math.round(aircraftData.finalRangeKm)?.toLocaleString('pt-BR') || '0'} km`;
            document.getElementById('turn_time').textContent = `${aircraftData.turn_time_s?.toFixed(1) || '0'}s`;
            document.getElementById('num_crewmen').textContent = aircraftData.inputs?.numCrewmen || '0';
            document.getElementById('offensive_armament').textContent = aircraftData.offensiveArmamentTexts?.length > 0 ? aircraftData.offensiveArmamentTexts.join(', ') : 'Nenhum';
            document.getElementById('defensive_armament').textContent = aircraftData.defensiveArmamentTexts?.length > 0 ? aircraftData.defensiveArmamentTexts.join(', ') : 'Nenhum';
            document.getElementById('aircraft_type').textContent = aircraftData.typeData?.name || '-';
            document.getElementById('structure_type').textContent = aircraftData.inputs?.structureType ? gameData.components.structure_materials[aircraftData.inputs.structureType]?.name : '-';
            document.getElementById('propeller_type').textContent = aircraftData.inputs?.propellerType ? gameData.components.propellers[aircraftData.inputs.propellerType]?.name : '-';
            document.getElementById('cooling_system').textContent = aircraftData.inputs?.coolingSystem ? gameData.components.cooling_systems[aircraftData.inputs.coolingSystem]?.name : '-';
            document.getElementById('wing_type').textContent = aircraftData.inputs?.wingType ? gameData.components.wing_types[aircraftData.inputs.wingType]?.name : '-';
            document.getElementById('landing_gear_type').textContent = aircraftData.inputs?.landingGearType ? gameData.components.landing_gear_types[aircraftData.inputs.landingGearType]?.name : '-';
            populateEquipmentList('wing_features', aircraftData.inputs?.checkboxes?.wing_features.map(id => gameData.components.wing_features[id]?.name));
            populateEquipmentList('engine_enhancements', aircraftData.inputs?.checkboxes?.engine_enhancements.map(id => gameData.components.engine_enhancements[id]?.name));
            populateEquipmentList('protection', aircraftData.inputs?.checkboxes?.protection.map(id => gameData.components.protection[id]?.name));
            populateEquipmentList('cockpit_comfort', aircraftData.inputs?.checkboxes?.cockpit_comfort.map(id => gameData.components.cockpit_comfort[id]?.name));
            populateEquipmentList('advanced_avionics', aircraftData.inputs?.checkboxes?.advanced_avionics.map(id => gameData.components.advanced_avionics[id]?.name));
            populateEquipmentList('equipment', aircraftData.inputs?.checkboxes?.equipment.map(id => gameData.components.equipment[id]?.name));
            populateEquipmentList('maintainability_features', aircraftData.inputs?.checkboxes?.maintainability_features?.map(id => gameData.components.maintainability_features[id]?.name));
        }

        function populateEquipmentList(elementId, items) {
            const container = document.getElementById(elementId);
            if (!container) return;
            container.innerHTML = '';
            if (items && items.length > 0 && items.some(item => item !== undefined)) {
                container.innerHTML = items.filter(item => item !== undefined).map(item => `<div class="py-1 text-xs">‚Ä¢ ${item}</div>`).join('');
            } else {
                container.innerHTML = '<div class="text-gray-500 text-xs">Nenhum</div>';
            }
        }

        function populateAircraftSelect(aircraftList) {
            const select = document.getElementById('aircraft_select');
            select.innerHTML = '<option value="">Selecione...</option>';
            aircraftList.forEach(aircraft => {
                const option = document.createElement('option');
                option.value = aircraft.id;
                option.textContent = aircraft.name;
                select.appendChild(option);
            });
        }

        function createPerformanceChart() {
            if (!aircraftData.performanceGraphData) {
                aircraftData.performanceGraphData = generatePerformanceGraphData(aircraftData);
            }

            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }

            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: aircraftData.performanceGraphData.map(d => `${(d.altitude / 1000).toFixed(0)}km`),
                    datasets: [{
                        label: 'Velocidade',
                        data: aircraftData.performanceGraphData.map(d => d.speed),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true,
                    }, {
                        label: 'Subida',
                        data: aircraftData.performanceGraphData.map(d => d.roc),
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        fill: true,
                        yAxisID: 'y1',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { font: { size: 10 } } } },
                    scales: {
                        x: { ticks: { font: { size: 9 } } },
                        y: { position: 'left', ticks: { font: { size: 9 } } },
                        y1: { position: 'right', ticks: { font: { size: 9 } } }
                    }
                }
            });
        }

        function generatePerformanceGraphData(performanceData) {
            if (!performanceData.combatWeight || !performanceData.totalEnginePower || !performanceData.propData || !performanceData.aero || !performanceData.superchargerData || !performanceData.typeData) {
                console.error("Dados incompletos para gerar o gr√°fico de performance.");
                return [];
            }
            
            const { combatWeight, totalEnginePower, propData, aero, superchargerData, finalServiceCeiling, typeData } = performanceData;
            const data = [];
            for (let h = 0; h <= 15000; h += 1000) {
                let currentAlt = h;
                if (h > finalServiceCeiling && finalServiceCeiling > 0) {
                    currentAlt = finalServiceCeiling;
                }
                const perfPoint = calculatePerformanceAtAltitude(currentAlt, combatWeight, totalEnginePower, propData, aero, superchargerData);
                let cappedSpeed = perfPoint.speed_kmh * aero.speed_mod;
                if (typeData.limits && cappedSpeed > typeData.limits.max_speed) {
                    cappedSpeed = typeData.limits.max_speed;
                }
                data.push({
                    altitude: currentAlt,
                    speed: h > finalServiceCeiling && finalServiceCeiling > 0 ? 0 : cappedSpeed,
                    roc: h > finalServiceCeiling && finalServiceCeiling > 0 ? 0 : calculateRateOfClimb(currentAlt, combatWeight, totalEnginePower, propData, aero, superchargerData)
                });
                if (h >= finalServiceCeiling && finalServiceCeiling > 0) {
                    if (data[data.length -1].altitude !== finalServiceCeiling) {
                        data.push({
                            altitude: finalServiceCeiling,
                            speed: Math.min(calculatePerformanceAtAltitude(finalServiceCeiling, combatWeight, totalEnginePower, propData, aero, superchargerData).speed_kmh * aero.speed_mod, typeData.limits.max_speed),
                            roc: 0
                        });
                    }
                    break;
                }
            }
            return data;
        }

        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            const icon = document.getElementById(cardId + '_icon');
            if (card && icon) {
                card.classList.toggle('expanded');
                icon.classList.toggle('rotate-180');
            }
        }

        function openImageSelector() {
            document.getElementById('image_modal').classList.remove('hidden');
            document.getElementById('image_modal').classList.add('flex');
        }

        function closeImageSelector() {
            document.getElementById('image_modal').classList.add('hidden');
            document.getElementById('image_modal').classList.remove('flex');
        }

        function applyImageSelection() {
            const fileInput = document.getElementById('image_upload');
            const selectInput = document.getElementById('aircraft_select');
            const imageElement = document.getElementById('aircraft_image');

            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { imageElement.src = e.target.result; };
                reader.readAsDataURL(fileInput.files[0]);
            } else if (selectInput.value) {
                const selectedAircraft = realWorldAircraft.find(a => a.id === selectInput.value);
                if (selectedAircraft && selectedAircraft.image_url) {
                    imageElement.src = selectedAircraft.image_url;
                }
            }
            closeImageSelector();
        }

        function saveAsPNG() {
            if (!aircraftData.performanceGraphData || aircraftData.performanceGraphData.length === 0) {
                console.error("Dados do gr√°fico de performance ausentes ou incompletos.");
                return;
            }
            const downloadLayout = createDownloadLayout();
            document.body.appendChild(downloadLayout);

            const offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = 700;
            offscreenCanvas.height = 350;
            const chartCtx = offscreenCanvas.getContext('2d');
            
            const tempChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: aircraftData.performanceGraphData.map(d => `${(d.altitude / 1000).toFixed(0)}km`),
                    datasets: [{
                        label: 'Velocidade',
                        data: aircraftData.performanceGraphData.map(d => d.speed),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true,
                    }, {
                        label: 'Subida',
                        data: aircraftData.performanceGraphData.map(d => d.roc),
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        fill: true,
                        yAxisID: 'y1',
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { font: { size: 10 } } } },
                    scales: {
                        x: { ticks: { font: { size: 9 } } },
                        y: { position: 'left', ticks: { font: { size: 9 } } },
                        y1: { position: 'right', ticks: { font: { size: 9 } } }
                    }
                }
            });

            setTimeout(() => {
                const chartImg = document.createElement('img');
                chartImg.src = offscreenCanvas.toDataURL('image/png');
                chartImg.style.width = '100%';
                chartImg.style.height = '100%';
                
                const chartContainer = downloadLayout.querySelector('#download-chart-container');
                if (chartContainer) {
                    chartContainer.innerHTML = '';
                    chartContainer.appendChild(chartImg);
                }

                html2canvas(downloadLayout, {
                    scale: 2, 
                    useCORS: true,
                    backgroundColor: null
                }).then(canvas => {
                    document.body.removeChild(downloadLayout);
                    tempChart.destroy();
                    const link = document.createElement('a');
                    link.download = `${aircraftData.inputs?.aircraftName?.replace(/ /g, '_') || 'aeronave'}_ficha.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            }, 500);
        }

        function createDownloadLayout() {
            const layout = document.createElement('div');
            layout.style.cssText = `
                position: fixed;
                top: -10000px;
                left: -10000px;
                width: 1200px; 
                height: 800px;
                background: linear-gradient(135deg, #87CEEB 0%, #1E90FF 100%);
                padding: 20px;
                font-family: 'Inter', sans-serif;
                box-sizing: border-box;
                display: flex; 
                flex-direction: column;
            `;

            layout.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 20px; height: 100%; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <!-- Header -->
                    <div style="background: linear-gradient(45deg, #4682B4, #5F9EA0); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px;">
                        <h1 style="font-size: 28px; margin: 0 0 5px 0; font-weight: bold;">${aircraftData.inputs?.aircraftName || 'Nome da Aeronave'}</h1>
                        <p style="font-size: 16px; margin: 0; opacity: 0.9;">${aircraftData.typeData?.name || 'Tipo'} - ${aircraftData.inputs?.selectedAirDoctrine ? gameData.doctrines[aircraftData.inputs.selectedAirDoctrine]?.name : 'Doutrina'}</p>
                    </div>

                    <!-- Main Content - Horizontal Sections -->
                    <div style="display: flex; gap: 20px; flex: 1;">
                        <!-- Left Section: Image and Quick Stats -->
                        <div style="flex: 0 0 300px; display: flex; flex-direction: column; gap: 15px;">
                            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; text-align: center;">
                                <img src="${document.getElementById('aircraft_image').src}" style="width: 100%; height: 180px; object-fit: contain; border-radius: 8px; border: 2px solid #e2e8f0;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px;">
                                <div style="background: #dbeafe; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="color: #1d4ed8; font-weight: 600;">${aircraftData.adjustedUnitCost?.toLocaleString('pt-BR') || '$0'}</div>
                                    <div style="color: #6b7280;">Custo</div>
                                </div>
                                <div style="background: #dcfce7; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="color: #059669; font-weight: 600;">${Math.round(aircraftData.finalSpeedKmhAlt)?.toLocaleString('pt-BR') || '0'} km/h</div>
                                    <div style="color: #6b7280;">Vel. M√°x</div>
                                </div>
                                <div style="background: #fae8ff; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="color: #9333ea; font-weight: 600;">${Math.round(aircraftData.totalEnginePower)?.toLocaleString('pt-BR') || '0'} HP</div>
                                    <div style="color: #6b7280;">Pot√™ncia</div>
                                </div>
                                <div style="background: #fed7aa; padding: 10px; border-radius: 8px; text-align: center;">
                                    <div style="color: #ea580c; font-weight: 600;">${aircraftData.finalReliability?.toFixed(1) || '0'}%</div>
                                    <div style="color: #6b7280;">Confiabilidade</div>
                                </div>
                            </div>
                        </div>

                        <!-- Middle Section: Detailed Stats and Chart -->
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 15px;">
                            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px;">
                                <h3 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600; color: #374151;">üìà Gr√°fico de Performance</h3>
                                <div id="download-chart-container" style="position: relative; width: 100%; height: 300px;"></div>
                            </div>
                            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; flex: 1;">
                                <h3 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600; color: #374151;">üìà Estat√≠sticas Detalhadas</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; font-size: 11px;">
                                    <div style="background: white; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Peso:</span>
                                        <span style="font-weight: 500;">${Math.round(aircraftData.combatWeight)?.toLocaleString('pt-BR') || '0'} kg</span>
                                    </div>
                                    <div style="background: white; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Subida:</span>
                                        <span style="font-weight: 500;">${aircraftData.rate_of_climb_ms?.toFixed(1) || '0'} m/s</span>
                                    </div>
                                    <div style="background: white; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Teto:</span>
                                        <span style="font-weight: 500;">${Math.round(aircraftData.finalServiceCeiling)?.toLocaleString('pt-BR') || '0'} m</span>
                                    </div>
                                    <div style="background: white; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Alcance:</span>
                                        <span style="font-weight: 500;">${Math.round(aircraftData.finalRangeKm)?.toLocaleString('pt-BR') || '0'} km</span>
                                    </div>
                                    <div style="background: white; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Manobra:</span>
                                        <span style="font-weight: 500;">${aircraftData.turn_time_s?.toFixed(1) || '0'}s</span>
                                    </div>
                                    <div style="background: white; padding: 8px; border-radius: 6px; display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Tripula√ß√£o:</span>
                                        <span style="font-weight: 500;">${aircraftData.inputs?.numCrewmen || '0'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Section: Armaments and Design Details (now larger) -->
                        <div style="flex: 0 0 350px; display: flex; flex-direction: column; gap: 15px; font-size: 11px;">
                            <div style="background: #fef2f2; border-radius: 10px; padding: 15px;">
                                <h3 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600; color: #374151;">üéØ Armamentos</h3>
                                <div style="margin-bottom: 8px;">
                                    <span style="font-weight: 600; color: #6b7280;">Ofensivo:</span>
                                    <div style="margin-top: 2px;">${aircraftData.offensiveArmamentTexts?.length > 0 ? aircraftData.offensiveArmamentTexts.join(', ') : 'Nenhum'}</div>
                                </div>
                                <div>
                                    <span style="font-weight: 600; color: #6b7280;">Defensivo:</span>
                                    <div style="margin-top: 2px;">${aircraftData.defensiveArmamentTexts?.length > 0 ? aircraftData.defensiveArmamentTexts.join(', ') : 'Nenhum'}</div>
                                </div>
                            </div>
                            <div style="background: #f3f4f6; border-radius: 10px; padding: 15px; flex: 1;">
                                <h3 style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600; color: #374151;">‚öôÔ∏è Projeto & Equipamentos</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                                    <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 4px;">
                                        <span style="font-weight: 600; color: #6b7280;">Tipo:</span> ${aircraftData.typeData?.name || '-'}
                                    </div>
                                    <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 4px;">
                                        <span style="font-weight: 600; color: #6b7280;">Estrutura:</span> ${aircraftData.inputs?.structureType ? gameData.components.structure_materials[aircraftData.inputs.structureType]?.name : '-'}
                                    </div>
                                    <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 4px;">
                                        <span style="font-weight: 600; color: #6b7280;">H√©lice:</span> ${aircraftData.inputs?.propellerType ? gameData.components.propellers[aircraftData.inputs.propellerType]?.name : '-'}
                                    </div>
                                    <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 4px;">
                                        <span style="font-weight: 600; color: #6b7280;">Refrigera√ß√£o:</span> ${aircraftData.inputs?.coolingSystem ? gameData.components.cooling_systems[aircraftData.inputs.coolingSystem]?.name : '-'}
                                    </div>
                                    <div style="border-bottom: 1px solid #e5e7eb; padding-bottom: 4px;">
                                        <span style="font-weight: 600; color: #6b7280;">Asa:</span> ${aircraftData.inputs?.wingType ? gameData.components.wing_types[aircraftData.inputs.wingType]?.name : '-'}
                                    </div>
                                    <div style="padding-bottom: 4px;">
                                        <span style="font-weight: 600; color: #6b7280;">Trem de Pouso:</span> ${aircraftData.inputs?.landingGearType ? gameData.components.landing_gear_types[aircraftData.inputs.landingGearType]?.name : '-'}
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <div style="font-weight: 600; color: #6b7280; margin-bottom: 4px;">ü™∂ Asas:</div>
                                        ${getEquipmentListHTML(aircraftData.inputs?.checkboxes?.wing_features?.map(id => gameData.components.wing_features[id]?.name))}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #6b7280; margin-bottom: 4px;">üîß Motor:</div>
                                        ${getEquipmentListHTML(aircraftData.inputs?.checkboxes?.engine_enhancements?.map(id => gameData.components.engine_enhancements[id]?.name))}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #6b7280; margin-bottom: 4px;">üõ°Ô∏è Prote√ß√£o:</div>
                                        ${getEquipmentListHTML(aircraftData.inputs?.checkboxes?.protection?.map(id => gameData.components.protection[id]?.name))}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #6b7280; margin-bottom: 4px;">ü™ë Cockpit:</div>
                                        ${getEquipmentListHTML(aircraftData.inputs?.checkboxes?.cockpit_comfort?.map(id => gameData.components.cockpit_comfort[id]?.name))}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #6b7280; margin-bottom: 4px;">üì° Avi√¥nicos:</div>
                                        ${getEquipmentListHTML(aircraftData.inputs?.checkboxes?.advanced_avionics?.map(id => gameData.components.advanced_avionics[id]?.name))}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #6b7280; margin-bottom: 4px;">üõ†Ô∏è Equipamentos:</div>
                                        ${getEquipmentListHTML(aircraftData.inputs?.checkboxes?.equipment?.map(id => gameData.components.equipment[id]?.name))}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #6b7280; margin-bottom: 4px;">‚öôÔ∏è Manuten√ß√£o:</div>
                                        ${getEquipmentListHTML(aircraftData.inputs?.checkboxes?.maintainability_features?.map(id => gameData.components.maintainability_features[id]?.name))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            return layout;
        }

        function getEquipmentListHTML(items) {
            if (items && items.length > 0 && items.some(item => item !== undefined)) {
                return items.filter(item => item !== undefined).map(item => `<div style="font-size: 10px; margin-bottom: 2px;">‚Ä¢ ${item}</div>`).join('');
            }
            return '<div style="font-size: 10px; color: #9ca3af;">Nenhum</div>';
        }
    </script>
</body>
</html>
